<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Test jQluster.RemoteSelectorFactory</title>
<link rel="stylesheet" href="./qunit.css">
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>
<script src="../js/lib/jquery.js"></script>
<script src="../js/lib/jquery.ellocate.js"></script>
<script src="../js/lib/jquery.xpath.js"></script>
<script src="./qunit.js"></script>
<script src="../js/util.js"></script>
<script src="../js/connection.js"></script>
<script src="../js/local_server.js"></script>
<script src="../js/transport.js"></script>
<script src="../js/remote_selector.js"></script>
<script src="../js/remote_selector_factory.js"></script>
<script src="../js/jquery_adaptor.js"></script>
<script>
"use strict";

var is = strictEqual;

var alice;
var bob;

var setupHTML = function() {
    var html =
          '<ul class="list">'
        +   '<li>1</li>'
        +   '<li>2</li>'
        +   '<li>3</li>'
        + '</ul>';
    $("#qunit-fixture").append(html);
};

var teardownjQluster = function() {
    alice = undefined;
    bob = undefined;
    jQluster.RemoteSelectorFactory.releaseLocalServer();
};

module("RemoteSelectorFactory", {
    setup: function() {
        alice = new jQluster.RemoteSelectorFactory({
            my_remote_id: "alice",
            transport_id: "local",
        });
        bob = new jQluster.RemoteSelectorFactory({
            my_remote_id: "bob",
            transport_id: "local"
        });
    },
    teardown: teardownjQluster
});

$.each([
    {label: "selector", target: "#hoge",  exp_eval_code: '$("#hoge")'},
    {label: "document", target: document, exp_eval_code: '$(document)'},
    {label: 'window', target: window, exp_eval_code: '$(window)'},
    {label: 'XPath remote pointer (same node)',
     target: {remote_type: "xpath", remote_id: "bob", remote_xpath: "//html[1]/body[1]/div[@id='hoge']"},
     exp_eval_code: "$(document).xpath(\"//html[1]/body[1]/div[@id='hoge']\")"},
    {label: 'XPath remote pointer (different node)',
     target: {remote_type: "xpath", remote_id: "carol", remote_xpath: "//html[1]/body[1]/div[@id='foobar']"},
     exp_remote_id: 'carol', exp_eval_code: "$(document).xpath(\"//html[1]/body[1]/div[@id='foobar']\")"}
], function(i, testcase) {
    if(!testcase.exp_remote_id) {
        testcase.exp_remote_id = "bob";
    }
    var checker = function(remote) {
        is(remote.remote_id, testcase.exp_remote_id, "remote object to bob");
        is(remote._getEvalCode(), testcase.exp_eval_code, "eval code OK");
    };
    test(testcase.label + ", function interface", function() {
        var factory = alice.forRemote("bob");
        var remote = factory(testcase.target);
        checker(remote);
    });
    test(testcase.label + ", direct interface", function() {
        var remote = alice.forRemote("bob", testcase.target);
        checker(remote);
    });
});

module("jQuery plugin adaptor", {
    setup: function() {
        setupHTML();
        $.jqluster.init("carol", "local");
        bob = new jQluster.RemoteSelectorFactory({
            my_remote_id: "bob",
            transport_id: "local"
        });
    },
    teardown: teardownjQluster
});

asyncTest("animation", function() {
    var $b = $.jqluster("bob");
    var list = $b("#qunit-fixture").find(".list");
    list.fadeOut(50);
    list.promise().then(function() {
        return this.css("display");
    }).then(function(css_display) {
        is(css_display, "none");
    }, function(error) {
        ok(false, "error: " + error);
    }).always(function() {
        start();
    });
});

asyncTest("each", function() {
    var $b = $.jqluster("bob");
    var results = [];
    var list_elems = $b("#qunit-fixture .list").children();
    console.log(list_elems);
    list_elems.each(function(i) {
        $b(this).text().then(function(text) {
            results.push([i, text]);
        });
    });
    setTimeout(function() {
        deepEqual(results, [[0, "1"], [1, "2"], [2, "3"]]);
        start();
    }, 100);
});

</script>
</body>
</html>
