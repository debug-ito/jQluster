<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Test jQluster.Transport</title>
<link rel="stylesheet" href="./qunit.css">
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>
<div id="test">
  <ul>
    <li>1</li>
    <li class="two">2</li>
    <li>3</li>
  </ul>
</div>
<script src="../js/jquery.js"></script>
<script src="./qunit.js"></script>
<script src="../js/util.js"></script>
<script src="../js/transport.js"></script>
<script src="../js/local_server.js"></script>
<script>
"use strict";

var server;
var alice;
var alice_connection;
var bob;
var bob_connection;

var is = strictEqual;

var createTransport = function(remote_id) {
    var conn = new jQluster.ConnectionLocal(server);
    var trans = new jQluster.Transport({
        remote_id: remote_id,
        connection_object: conn
    });
    return [conn, trans];
};

var setupAlice = function() {
    var ret = createTransport("alice");
    alice_connection = ret[0];
    alice = ret[1];
};

var setupBob = function() {
    var ret = createTransport("bob");
    bob_connection = ret[0];
    bob = ret[1];
};

module("jQluster.Transport", {
    setup: function() {
        server = new jQluster.ServerLocal();
    },
    teardown: function() {
        server = undefined;
        alice = undefined;
        alice_connection = undefined;
        bob = undefined;
        bob_connection = undefined;
    }
});

test("registration", function() {
    setupAlice();
    setupBob();
    deepEqual(server.getRegisterLog(), ["alice", "bob"], "registration OK");
    $.each([
        {id: "alice", log: alice_connection.getLog()},
        {id: "bob",   log: bob_connection.getLog()}
    ], function(i, params) {
        var id = params.id;
        var log = params.log;
        is(log.length, 2, "2 communication logs");
        is(log[0].direction, "send", "log 0 : send");
        is(log[0].message.message_type, "register", "log 0 : register");
        is(log[0].message.from, id, "log 0 from");
        is(log[0].message.to, null, "log 0 to");
        deepEqual(log[0].message.body, {remote_id: id}, "log 0 body");
        
        is(log[1].direction, "receive", "log 1 : receive");
        is(log[1].message.message_type, "register_reply", "log 1 : register_reply");
        is(log[1].message.from, null, "log 1 from");
        is(log[1].message.to, id, "log 1 to");
        deepEqual(log[1].message.body, {error: null, in_reply_to: log[0].message.message_id}, "log 1 body");
    });
});

asyncTest("selectAndGet - single target", function() {
    setupAlice();
    setupBob();
    alice_connection.clearLog();
    bob_connection.clearLog();

    alice.selectAndGet({
        eval_code: "$(\"#test\").find(\".two\").text()",
        remote_id: "bob"
    }).then(function(data) {
        var alog = alice_connection.getLog();
        var blog = bob_connection.getLog();
        is(data, "2", "obtained data OK");
        is(alog.length, 2);
        is(blog.length, 2);
        is(alog[0].direction, "send");
        is(alog[0].message.message_type, "select_and_get");
        is(alog[0].message.from, "alice");
        is(alog[0].message.to, "bob");
        deepEqual(alog[0].message.body, {
            eval_code: "$(\"#test\").find(\".two\").text()",
            remote_id: "bob"
        });
        is(blog[0].direction, "receive");
        is(blog[0].message.message_type, "select_and_get");
        is(blog[0].message.from, "alice");
        is(blog[0].message.to, "bob");
        is(blog[0].message.message_id, alog[0].message.message_id);
        deepEqual(blog[0].message.body, {
            eval_code: "$(\"#test\").find(\".two\").text()",
            remote_id: "bob"
        });

        is(blog[1].direction, "send");
        is(blog[1].message.message_type, "select_and_get_reply");
        is(blog[1].message.from, "bob");
        is(blog[1].message.to, "alice");
        deepEqual(blog[1].message.body, { error: null, result: "2", in_reply_to: alog[0].message.message_id });
        is(alog[1].direction, "receive");
        is(alog[1].message.message_type, "select_and_get_reply");
        is(alog[1].message.from, "bob");
        is(alog[1].message.to, "alice");
        is(alog[1].message.message_id, blog[1].message.message_id);
        deepEqual(alog[1].message.body, { error: null, result: "2", in_reply_to: alog[0].message.message_id });
    }, function(error) {
        ok(false, "error: " + error);
    }).always(function() {
        start();
    });
});

asyncTest("selectAndGet - no target: messages should be pending.", function() {
    setupAlice();
    var promise_select = alice.selectAndGet({
        eval_code: "$('#test li').eq(2).text()",
        remote_id: "bob"
    });
    var deferred_bob = $.Deferred();
    setTimeout(function() {
        setupBob();
        deferred_bob.resolve();
    }, 0.001);
    $.when(promise_select, deferred_bob.promise()).then(function(data) {
        var alog = alice_connection.getLog();
        var blog = bob_connection.getLog();
        is(data, "3", "data OK");
        is(alog.length, 4);
        is(blog.length, 4);
        is(alog[0].direction, "send");
        is(alog[0].message.message_type, "register");
        is(alog[1].direction, "receive");
        is(alog[1].message.message_type, "register_reply");
        is(alog[2].direction, "send");
        is(alog[2].message.message_type, "select_and_get");
        is(alog[2].message.from, "alice");
        is(alog[2].message.to, "bob");
        deepEqual(alog[2].message.body, {eval_code: "$('#test li').eq(2).text()", remote_id: "bob"});
        is(alog[3].direction, "receive");
        is(alog[3].message.message_type, "select_and_get_reply");
        is(alog[3].message.from, "bob");
        is(alog[3].message.to, "alice");
        deepEqual(alog[3].message.body, {error: null, result: "3", in_reply_to: alog[2].message.message_id});

        is(blog[0].direction, "send");
        is(blog[0].message.message_type, "register");
        is(blog[1].direction, "receive");
        is(blog[1].message.message_type, "register_reply");
        is(blog[2].direction, "receive");
        is(blog[2].message.message_type, "select_and_get");
        is(blog[2].message.from, "alice");
        is(blog[2].message.to, "bob");
        deepEqual(blog[2].message.body, {eval_code: "$('#test li').eq(2).text()", remote_id: "bob"});
        is(blog[3].direction, "send");
        is(blog[3].message.message_type, "select_and_get_reply");
        is(blog[3].message.from, "bob");
        is(blog[3].message.to, "alice");
        deepEqual(blog[3].message.body, {error: null, result: "3", in_reply_to: blog[2].message.message_id});
    }, function(error) {
        ok(false, "error: " + error);
    }).always(function() {
        start();
    });
});

asyncTest("selectAndGet - multiple targets: the result is returned from any one of the receivers.", function() {
    setupAlice();
    setupBob();
    var bob2_set = createTransport("bob");
    var bob2_connection = bob2_set[0];
    alice_connection.clearLog();
    bob_connection.clearLog();
    bob2_connection.clearLog();
    alice.selectAndGet({
        eval_code: "$('#test > ul').eq(0).children().eq(1).text()",
        remote_id: "bob"
    }).then(function(data) {
        var alog = alice_connection.getLog();
        var blog = bob_connection.getLog();
        var b2log = bob_connection.getLog();
        is(data, "2");
        ok(alog.length >= 2, "alog should include 1 send and at least 1 receive.");
        is(alog[0].direction, "send");
        is(alog[0].message.message_type, "select_and_get");
        is(alog[0].message.from, "alice");
        is(alog[0].message.to, "bob");
        deepEqual(alog[0].message.body, {eval_code: "$('#test > ul').eq(0).children().eq(1).text()", remote_id: "bob"});
        is(alog[1].direction, "receive");
        is(alog[1].message.message_type, "select_and_get_reply");
        is(alog[1].message.to, "alice");
        is(alog[1].message.from, "bob");
        deepEqual(alog[1].message.body, {error: null, result: "2", in_reply_to: alog[0].message.message_id});

        $.each([{label: "bob", log: blog}, {label: "bob2", log: b2log}], function(i, e) {
            ok(e.log.length >= 1, e.log.label + " should at least have 'receive' log from alice");
            is(e.log[0].direction, "receive", e.log.label + " [0] receive");
            is(e.log[0].message.message_type, "select_and_get", e.log.label + " [0] type = select_and_get");
            is(e.log[0].message.from, "alice", e.log.label + " [0] from = alice");
            is(e.log[0].message.to, "bob", e.log.label + " [0] to = bob");
            deepEqual(e.log[0].message.body, {eval_code: "$('#test > ul').eq(0).children().eq(1).text()", remote_id: "bob"}, e.log.label + " [0] body OK");
        });
    }, function(error) {
        ok(false, "error: " + error);
    }).always(function() {
        start();
    });
});

// TODO:
// - selectAndGet with multiple targets.
// - selectAndListen


</script>
</body>
</html>
